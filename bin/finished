#!/usr/bin/env ruby
require 'json'

current_branch_name = `git rev-parse --abbrev-ref HEAD`.chomp
current_story_id = current_branch_name.match(/\/([0-9]*)/)[1]
if current_story_id == current_story_id.to_i
  raise 'Story ID not an integer'
end

pull_request_title = current_branch_name.sub('feature/', '').tr('-', ' ')

`git push`

pull_request_properties = {
  'title' => pull_request_title,
  'body' => "https://www.pivotaltracker.com/story/show/#{ current_story_id }",
  'head' => current_branch_name,
  'base' => 'develop'
}
pull_request = JSON.parse(`curl --silent -H "Authorization: token #{ ENV['GITHUB_PR_CREATE_TOKEN'] }" -H "Content-Type: application/json" -d '#{ pull_request_properties.to_json }' "https://api.github.com/repos/developertown/baldwin-web/pulls"`)

new_story_properties = {
  'current_state' => 'finished'
}
`curl --silent -X PUT -H "X-TrackerToken: #{ ENV['PIVOTAL_TOKEN'] }" -H "Content-Type: application/json" -d '#{ new_story_properties.to_json }' "https://www.pivotaltracker.com/services/v5/projects/#{ ENV['PIVOTAL_PROJECT_ID'] }/stories/#{ current_story_id }"`

comment_properties = {
  'text' => pull_request['html_url']
}
`curl --silent -X POST -H "X-TrackerToken: #{ ENV['PIVOTAL_TOKEN'] }" -H "Content-Type: application/json" -d '#{ comment_properties.to_json }' "https://www.pivotaltracker.com/services/v5/projects/#{ ENV['PIVOTAL_PROJECT_ID'] }/stories/#{ current_story_id }/comments"`
