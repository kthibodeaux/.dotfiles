# vi: set ft=sh :

# Keep-alive: update existing `sudo` time stamp until `setup` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

RUBY_VERSION="2.2.2"

apt_install() {
  if dpkg -s $1 > /dev/null; then
    echo "skipping $1: already installed"
  else
    sudo apt-get -y install $1
  fi
}

font_install() {
  if [ -f "$HOME/.fonts/$1" ]; then
    echo "skipping $1: already installed"
  else
    wget -O "$HOME/.fonts/$1" "$2"
  fi
}

if [ -f /etc/apt/sources.list.d/enpass.list ]; then
  echo "skipping creating enpass apt list: already exists"
else
  echo 'deb http://repo.sinew.in/ stable main' | sudo tee -a /etc/apt/sources.list.d/enpass.list
fi

sudo apt-get update

apt_install "avrdude"
apt_install "avr-libc"
apt_install "compton"
apt_install "curl"
apt_install "dfu-programmer"
apt_install "ecryptfs-utils"
apt_install "enpass"
apt_install "feh"
apt_install "gcc-avr"
apt_install "git-flow"
apt_install "glances"
apt_install "htop"
apt_install "i3blocks"
apt_install "i3lock"
apt_install "libappindicator1"
apt_install "libpq-dev"
apt_install "neovim"
apt_install "pgcli"
apt_install "postgresql-9.5"
apt_install "python3"
apt_install "python3-pip"
apt_install "ranger"
apt_install "redis-server"
apt_install "redshift-gtk"
apt_install "rofi"
apt_install "ruby"
apt_install "scrot"
apt_install "silversearcher-ag"
apt_install "stterm"
apt_install "thunderbird"
apt_install "tmux"
apt_install "tree"
apt_install "xclip"
apt_install "zsh"
echo ""

if [ $(getent passwd $LOGNAME | cut -d: -f7) == "/usr/bin/zsh" ]; then
  echo "skipping change shell: shell is already zsh"
else
  echo "setting shell to /usr/bin/zsh"
  chsh -s /usr/bin/zsh
fi
echo ""

if [ -d ~/.rvm ]; then
  echo "skipping rvm: already installed"
else
  gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
  curl -sSL https://get.rvm.io | bash -s stable
fi
echo ""

echo "sourcing rvm script"
source "$HOME/.rvm/scripts/rvm"

if rvm use $RUBY_VERSION > /dev/null; then
  echo "skipping install ruby $RUBY_VERSION: already installed"
else
  rvm install $RUBY_VERSION
  rvm --default use $RUBY_VERSION
  rvm use $RUBY_VERSION
  gem install bundler
  gem install neovim
  gem install reek
  gem install rubocop
fi
echo ""

if [ -d ~/.fzf ]; then
  echo "skipping fzf: already installed"
else
  git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
  ~/.fzf/install --key-bindings --completion --no-update-rc
fi
echo ""

if pip3 show neovim > /dev/null; then
  echo "skipping python3 neovim support: already installed"
else
  sudo pip3 install neovim
fi
echo ""

if test $(which dasht); then
  dasht-docsets-install -f ruby_2 ruby_on_rails_4 bootstrap_3 coffeescript css javascript jquery postgresql sass
fi
echo ""

mkdir ~/.fonts
font_install "fontawesome-webfont.ttf" "https://github.com/FortAwesome/Font-Awesome/raw/master/fonts/fontawesome-webfont.ttf"
font_install "System San Francisco Display Bold.ttf" "https://github.com/supermarin/YosemiteSanFranciscoFont/raw/master/System%20San%20Francisco%20Display%20Bold.ttf"
font_install "System San Francisco Display Ultralight.ttf" "https://github.com/supermarin/YosemiteSanFranciscoFont/raw/master/System%20San%20Francisco%20Display%20Ultralight.ttf"
font_install "System San Francisco Display Regular.ttf" "https://github.com/supermarin/YosemiteSanFranciscoFont/raw/master/System%20San%20Francisco%20Display%20Regular.ttf"
font_install "System San Francisco Display Thin.ttf" "https://github.com/supermarin/YosemiteSanFranciscoFont/raw/master/System%20San%20Francisco%20Display%20Thin.ttf"
font_install "Menlo Regular.ttf" "https://github.com/hbin/top-programming-fonts/raw/master/Menlo-Regular.ttf"
sudo fc-cache -f
echo ""

echo ""
echo ""
echo "If this is your first time running setup on this computer then you may"
echo "want to:"
echo ""
echo "Run 'vu' to install vim plugins"
echo "Run ':UpdateRemotePlugins' in neovim"
echo "Setup postgres (see README.md)"
echo "Improve postgres performance: https://wiki.archlinux.org/index.php/PostgreSQL#Improve_performance_of_small_transactions"
echo "Comment out the line that remaps the capslock key to backspace for Colemak in /usr/share/X11/xkb/symbols/us"
